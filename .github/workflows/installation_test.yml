---
name: Installation CI
on:  # yamllint disable-line rule:truthy
  push:
    branches: [main]
    paths: [scripts/, .github/workflows/installation_test.yml]
  pull_request:
    paths: [scripts/, .github/workflows/installation_test.yml]
  workflow_dispatch:
  schedule:
    - cron: 23 11 * * *

concurrency:
  group: |
    ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

jobs:
  install_linux:
    name: |
      Linux [${{ matrix.config.version }}, ${{ matrix.config.arch }},
      ${{ matrix.install_method }}]
    strategy:
      fail-fast: false
      matrix:
        config:
          - os: ubuntu-latest
            arch: x86-64
            version: stable
          - os: ubuntu-latest
            arch: x86-64
            version: nightly
          - os: ubuntu-latest
            arch: x86-64
            version: v0.9.0
          - os: ubuntu-24.04-arm
            arch: arm64
            version: stable
          - os: ubuntu-24.04-arm
            arch: arm64
            version: nightly
          - os: ubuntu-24.04-arm
            arch: arm64
            version: v0.10.4
        install_method: [binary, source]
    runs-on: ${{ matrix.config.os }}
    steps:
      - uses: actions/checkout@v4
      - name: Install build pre-requisites
        run: |
          sudo apt-get install -y ninja-build gettext \
          cmake unzip curl build-essential
      - name: Install Neovim
        shell: bash
        run: |-
          chmod +x ./scripts/neovim_install.sh ./scripts/neovim_download.sh \
          ./scripts/neovim_utils.sh
          ./scripts/neovim_install.sh -v ${{ matrix.config.version }} \
          -d ~/.remote-nvim \
          -m ${{ matrix.install_method }} -a x86_64
          ~/.remote-nvim/nvim-downloads/${{ matrix.neovim_version }}/bin/nvim -v
  install_macos:
    name: |
      MacOS [${{ matrix.neovim_version }}, ${{ matrix.config.arch }},
      ${{ matrix.install_method }}]
    strategy:
      fail-fast: false
      matrix:
        config:
          - {os: macos-13, arch: x86_64}
          - {os: macos-latest, arch: arm64}
        install_method: [binary, source]
        neovim_version: [stable, nightly, v0.9.0]
    runs-on: ${{ matrix.config.os }}
    steps:
      - uses: actions/checkout@v4
      - name: Install Neovim
        shell: bash
        run: |-
          chmod +x ./scripts/neovim_install.sh ./scripts/neovim_download.sh \
          ./scripts/neovim_utils.sh
          ./scripts/neovim_install.sh -v ${{ matrix.neovim_version }} \
          -d ~/.remote-nvim \
          -m ${{ matrix.install_method }} -a ${{ matrix.config.arch }}
          ~/.remote-nvim/nvim-downloads/${{ matrix.neovim_version }}/bin/nvim -v
  symlink_test:
    name: |
      Symlink [${{ matrix.config.version }},
      ${{ matrix.config.os }}-${{ matrix.config.arch }},
      ${{ matrix.install_method }}]
    strategy:
      fail-fast: false
      matrix:
        config:
          - os: ubuntu-latest
            arch: x86-64
            version: stable
          - os: ubuntu-latest
            arch: x86-64
            version: nightly
          - os: ubuntu-latest
            arch: x86-64
            version: v0.9.0
          - os: ubuntu-24.04-arm
            arch: arm64
            version: stable
          - os: ubuntu-24.04-arm
            arch: arm64
            version: nightly
          - os: ubuntu-24.04-arm
            arch: arm64
            version: v0.10.4
          - os: macos-13
            arch: x86-64
            version: stable
          - os: macos-13
            arch: x86-64
            version: nightly
          - os: macos-13
            arch: x86-64
            version: v0.9.0
          - os: macos-latest
            arch: arm64
            version: stable
          - os: macos-latest
            arch: arm64
            version: nightly
          - os: macos-latest
            arch: arm64
            version: v0.9.0
    runs-on: ${{ matrix.config.os }}
    steps:
      - uses: actions/checkout@v4
      - uses: rhysd/action-setup-vim@v1
        name: Install Neovim
        with:
          neovim: true
          version: ${{ matrix.config.version }}
      - name: Symlink Neovim to system neovim install
        shell: bash
        run: |-
          chmod +x ./scripts/neovim_install.sh ./scripts/neovim_download.sh \
          ./scripts/neovim_utils.sh
          ./scripts/neovim_install.sh -v system -d ~/.remote-nvim -m system \
           -a ${{ matrix.config.arch }}
          ~/.remote-nvim/nvim-downloads/system/bin/nvim -v
